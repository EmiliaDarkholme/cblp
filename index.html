<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Сырная тестами</title>
  <style>
    :root {
      --primary: #4f46e5;
      --success: #22c55e;
      --danger: #dc2626;
      --gray: #9ca3af;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100dvh;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(270deg, #dbe6f6, #e0c3fc, #f9f9f9, #cfd9df);
      background-size: 400% 400%;
      animation: gradientAnimation 30s ease infinite;
      touch-action: manipulation;
      -webkit-font-smoothing: antialiased;
    }
    @keyframes gradientAnimation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      background: #fff;
      padding: 2rem 1.5rem;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.18);
      width: 92%;
      max-width: 440px;
      margin: 2rem auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: #333;
      font-size: clamp(1.8rem, 5vw, 2.2rem);
    }

    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
      color: #444;
      font-size: 1.05rem;
    }

    input, select {
      width: 100%;
      padding: 0.9rem;
      margin-top: 0.4rem;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      background: #fff;
    }

    button {
      width: 100%;
      padding: 1rem;
      margin-top: 1.5rem;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #4CAF50, #2E8B57);
      color: white;
      font-size: 1.15rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover { transform: translateY(-2px); }
    button:active { transform: scale(0.98); }

    /* Модальные окна */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(5px);
      padding: 1rem;
      overflow-y: auto;
    }
    .modal.active {
      display: grid;
      place-items: center;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 900px;
      max-height: 95dvh;
      overflow-y: auto;
      padding: 2rem;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      -webkit-overflow-scrolling: touch;
    }

    .close {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 2.2rem;
      font-weight: bold;
      cursor: pointer;
      color: #aaa;
      width: 48px;
      height: 48px;
      display: grid;
      place-items: center;
      border-radius: 50%;
      z-index: 10;
    }
    .close:hover { background: #f0f0f0; color: #000; }

    .progress-bar {
      background: #e5e7eb;
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
      margin: 1.2rem 0;
    }
    .progress-fill {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 6px;
      transition: width 0.4s ease;
    }

    #timer {
      font-size: 1.7rem;
      font-weight: bold;
      color: #7c3aed;
    }
    #timer.warning { color: #f59e0b; }
    #timer.danger { color: #dc2626; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

    .option {
      padding: 1rem 1.2rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 0.8rem;
      cursor: pointer;
      background: #fcfcfc;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      font-size: 1.05rem;
    }
    .option:hover {
      background: #f3e8ff;
      border-color: #c4b5fd;
    }
    .option input {
      margin-right: 1rem;
      transform: scale(1.4);
      cursor: pointer;
    }

    .test-nav-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.8rem 1rem 1.2rem;
  user-select: none;
  position: relative;
}

.nav-arrow {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: rgba(79, 70, 229, 0.14);
  color: var(--primary);
  font-size: 2.8rem;
  font-weight: 300;
  display: grid;
  place-items: center;
  cursor: pointer;
  transition: all 0.25s ease;
  backdrop-filter: blur(8px);
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

.nav-arrow:hover:not(.disabled) {
  background: rgba(79, 70, 229, 0.26);
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 8px 20px rgba(79, 70, 229, 0.25);
}

.nav-arrow:active:not(.disabled) {
  transform: translateY(0) scale(0.94);
}

.nav-arrow.disabled {
  background: rgba(148, 163, 184, 0.15);
  color: #94a3b8;
  cursor: not-allowed;
  box-shadow: none;
  transform: none !important;
}

/* Для красоты — лёгкая анимация появления */
.nav-arrow {
  animation: fadeIn 0.4s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.8); }
  to { opacity: 1; transform: scale(1); }
}


#vova-cat {
  position: fixed;
  bottom: -500px !important;
  left: 50%;
  transform: translateX(-50%);
  width: 340px;
  height: 340px;
  background: url('vova-cat.gif') center/contain no-repeat;
  background-color: transparent !important;
  z-index: 99999;
  pointer-events: none;
  border: none !important;
  border-radius: 0 !important;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  transition: bottom 1.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  image-rendering: -webkit-optimize-contrast; /* чёткость на всех устройствах */
}
#vova-cat.show {
  bottom: 100px !important;
}
@media (max-width: 480px) {
  #vova-cat { width: 280px; height: 280px; }
  #vova-cat.show { bottom: 70px !important; }
}
  </style>
</head>
<body>

  <!-- Регистрация -->
  <div class="container" id="register">
    <h1>Регистрация</h1>
    <form id="registerForm">
      <label for="name">Имя:</label>
      <input type="text" id="name" required>
      <label for="course">Курс:</label>
      <select id="course" required>
        <option value="">Выберите курс</option>
        <option value="1">1 курс</option>
        <option value="2">2 курс</option>
        <option value="3">3 курс</option>
        <option value="4">4 курс</option>
        <option value="5">5 курс</option>
        <option value="6">6 курс</option>
      </select>
      <label for="faculty">Факультет:</label>
      <select id="faculty" required>
        <option value="">Выберите факультет</option>
        <option value="Лечебный">Лечебный</option>
        <option value="Педиатрический">Педиатрический</option>
        <option value="Медико-психологический">Медико-психологический</option>
        <option value="Медико-диагностический">Медико-диагностический</option>
      </select>
      <button type="submit">Зарегистрироваться</button>
    </form>
  </div>

  <!-- Меню -->
  <div class="container" id="menu" style="display:none;">
    <h1 id="greeting">Добро пожаловать!</h1>
    <nav style="display:flex; flex-direction:column; gap:15px; margin-top:20px;">
      <button onclick="openModal('testSelectionModal')">Начать тест</button>
      <button onclick="openModal('settingsModal')">Настройки</button>
      <button onclick="openModal('profileModal')">Профиль</button>
      <button onclick="openModal('aboutModal')">О нас</button>
      <button onclick="openModal('helpModal')">Помощь</button>
    </nav>
  </div>

  <!-- Выбор теста -->
  <div id="testSelectionModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('testSelectionModal')">×</span>
      <h2>Настройки теста</h2>
      <div style="margin-bottom:1.5rem;background:white;padding:1.25rem;border-radius:12px;border:2px solid #e5e7eb;">
        <label style="display:block;font-size:1.125rem;margin-bottom:0.75rem;">Количество вопросов:</label>
        <input type="number" id="question-count-custom" min="1" placeholder="Любое число" style="width:100%;padding:0.75rem;border-radius:10px;border:2px solid #d1d5db;">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;margin-top:0.75rem;">
          <button type="button" onclick="document.getElementById('question-count-custom').value=10" style="padding:0.6rem;background:#e5e7eb;border-radius:8px;">10</button>
          <button type="button" onclick="document.getElementById('question-count-custom').value=25" style="padding:0.6rem;background:#e5e7eb;border-radius:8px;">25</button>
          <button type="button" onclick="document.getElementById('question-count-custom').value=50" style="padding:0.6rem;background:#e5e7eb;border-radius:8px;">50</button>
          <button type="button" onclick="document.getElementById('question-count-custom').value=100" style="padding:0.6rem;background:#e5e7eb;border-radius:8px;">100</button>
          <button type="button" onclick="document.getElementById('question-count-custom').value=''" style="padding:0.6rem;background:#e5e7eb;border-radius:8px;grid-column:span 2;">Все</button>
        </div>
      </div>

      <div style="margin-bottom:1.5rem;background:white;padding:1.25rem;border-radius:12px;border:2px solid #e5e7eb;">
        <label style="display:flex;align-items:center;justify-content:space-between;">
          <span style="font-size:1.125rem;">Таймер</span>
          <input type="checkbox" id="use-timer" style="width:1.6rem;height:1.6rem;">
        </label>
        <input type="number" id="timer-minutes" value="30" min="1" max="180" style="width:100%;margin-top:0.75rem;padding:0.75rem;border-radius:10px;border:2px solid #d1d5db;" placeholder="Минут">
      </div>

      <div style="margin-bottom:1.5rem;background:white;padding:1.25rem;border-radius:12px;border:2px solid #e5e7eb;">
        <label style="display:flex;align-items:center;justify-content:space-between;">
          <span style="font-size:1.125rem;">Режим «вслепую»</span>
          <input type="checkbox" id="blind-mode" style="width:1.6rem;height:1.6rem;">
        </label>
      </div>

      <div style="margin-bottom:1.5rem;text-align:center;">
        <label style="display:flex;align-items:center;justify-content:center;font-size:1.125rem;">
          <input type="checkbox" id="show-all-toggle" onchange="buildTopicList()" style="margin-right:0.75rem;width:1.6rem;height:1.6rem;">
          <span>Все разделы</span>
        </label>
      </div>

      <h3 style="font-size:1.5rem;font-weight:bold;margin:1rem 0;">Разделы</h3>
      <div id="topics" style="max-height:45vh;overflow-y:auto;margin-bottom:2rem;"></div>

      <button onclick="startTest()" style="background:linear-gradient(135deg,#22c55e,#115e59);padding:1.2rem;font-size:1.3rem;font-weight:bold;">Начать тест</button>
    </div>
  </div>

  <!-- Тест -->
  <div id="testModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="showExitConfirm()">×</span>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;font-size:1.1rem;">
        <div>Вопрос <span id="current-num">1</span> / <span id="total-num">0</span></div>
        <div id="timer" style="display:none;"></div>
      </div>

      <div class="progress-bar"><div id="progress" class="progress-fill"></div></div>

      <div class="test-nav-top">
  <div id="prev-arrow-top" class="nav-arrow disabled">←</div>
  <div id="next-arrow-top" class="nav-arrow">→</div>
</div>

      <h3 id="question" style="font-size:1.4rem;margin:1.5rem 0;line-height:1.5;"></h3>
      <div id="options"></div>

      <div style="margin-top:2rem;display:flex;gap:1rem;">
        <button id="answer-btn" disabled style="flex:1;opacity:0.6;">Ответить</button>
        <button onclick="showExitConfirm(true)" style="background:var(--danger);">Завершить</button>
      </div>
    </div>
  </div>

  <!-- Подтверждение выхода -->
  <div id="exitConfirmModal" class="modal">
    <div class="modal-content" style="max-width:420px;text-align:center;">
      <h2 style="color:var(--danger);">Выйти из теста?</h2>
      <p style="font-size:1.1rem;margin:1.5rem 0;">Весь прогресс будет потерян.<br>Вы уверены?</p>
      <div style="display:flex;gap:1rem;">
        <button onclick="closeModal('exitConfirmModal')" style="background:#e5e7eb;color:#111;">Отмена</button>
        <button onclick="forceExit()" style="background:var(--danger);color:white;">Выйти</button>
      </div>
    </div>
  </div>

  <!-- Результаты -->
  <div id="resultsModal" class="modal">
    <div class="modal-content" style="text-align:center;">
      <span class="close" onclick="closeModal('resultsModal')">×</span>
      <div style="font-size:4.5rem;margin:1rem 0;">Trophy</div>
      <h2 style="font-size:2rem;">Тест завершён, <span id="results-name"></span>!</h2>
      <div style="background:#f9f9f9;padding:2rem;border-radius:16px;margin:1.5rem 0;">
        <p style="font-size:3.5rem;font-weight:bold;margin:0.5rem 0;">
          <span id="final-score">0</span> / <span id="final-total">0</span>
        </p>
        <p style="font-size:1.9rem;">Точность: <span id="final-percent">0</span>%</p>
        <p style="font-size:1.2rem;color:#666;" id="time-spent"></p>
      </div>
      <button onclick="closeModal('resultsModal'); openModal('testSelectionModal')" style="background:linear-gradient(135deg,#22c55e,#115e59);padding:1.2rem;font-size:1.3rem;">
        Новый тест
      </button>
    </div>
  </div>

  <!-- Остальные модалки -->
  <div id="settingsModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('settingsModal')">×</span><h2>Настройки</h2><form id="settingsForm"><label>Имя:</label><input type="text" id="setName"><label>Курс:</label><select id="setCourse"><option value="1">1 курс</option><option value="2">2 курс</option><option value="3">3 курс</option><option value="4">4 курс</option><option value="5">5 курс</option><option value="6">6 курс</option></select><label>Факультет:</label><select id="setFaculty"><option value="Лечебный">Лечебный</option><option value="Педиатрический">Педиатрический</option><option value="Медико-психологический">Медико-психологический</option><option value="Медико-диагностический">Медико-диагностический</option></select><button type="submit">Сохранить</button></form></div></div>

  <div id="profileModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('profileModal')">×</span><h2>Профиль</h2><p id="profileInfo"></p><hr><p>Тестов пройдено: <strong id="tests-completed">0</strong></p><p>Правильных ответов: <strong id="correct-total">0</strong></p><p>Средняя точность: <strong id="avg-percent">0</strong>%</p></div></div>

  <div id="aboutModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('aboutModal')">×</span><h2>О нас</h2><p>Этот проект создан для удобного прохождения учебных тестов студентами медицинских факультетов.</p></div></div>

  <div id="helpModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('helpModal')">×</span><h2>Помощь</h2><p>Все вопросы и предложения — в Telegram: <strong>@cblblblblp</strong></p></div></div>

  <!-- Пасхалка -->
  <div id="vova-cat"></div>

  <script>
    // === ВЕСЬ ТВОЙ ОРИГИНАЛЬНЫЙ JS (без изменений) ===
    let userName = "", userCourse = "", userFaculty = "";
    let user = JSON.parse(localStorage.getItem('medtests_user'));
    let stats = JSON.parse(localStorage.getItem('medtests_stats')) || { tests: 0, correct: 0 };
    let allTests = {};
    let currentTest = [], currentIndex = 0, correctInSession = 0;
    let timerInterval, startTime, testSettings = {};
    let testInProgress = false;

    async function loadTests() {
      const jsonFiles = ['Пропедевтика детских болезней.json','Радмед.json','Лучевая диагностика.json'];
      try {
        for (const file of jsonFiles) {
          const response = await fetch(file);
          if (!response.ok) throw new Error(`Ошибка загрузки ${file}`);
          const data = await response.json();
          const subject = file.replace('.json', '');
          allTests[subject] = data;
        }
        console.log('Тесты загружены');
        buildTopicList();
      } catch (e) {
        console.error(e);
        alert('Не удалось загрузить тесты. Проверьте наличие JSON-файлов.');
      }
    }
    loadTests();

    if (user) {
      userName = user.name; userCourse = user.course; userFaculty = user.faculty;
      document.getElementById('register').style.display = "none";
      document.getElementById('menu').style.display = "block";
      updateGreeting(); updateProfile();
    }

    document.getElementById("registerForm").addEventListener("submit", function(e) {
      e.preventDefault();
      userName = document.getElementById("name").value.trim();
      userCourse = document.getElementById("course").value;
      userFaculty = document.getElementById("faculty").value;
      if (!userName || !userCourse || !userFaculty) return;
      user = { name: userName, course: userCourse, faculty: userFaculty };
      localStorage.setItem('medtests_user', JSON.stringify(user));
      document.getElementById("register").style.display = "none";
      document.getElementById("menu").style.display = "block";
      updateGreeting(); updateProfile();
    });

    function updateGreeting() {
      const hour = new Date().getHours();
      const greeting = hour < 12 ? "Доброе утро" : hour < 18 ? "Добрый день" : hour < 23 ? "Добрый вечер" : "Доброй ночи";
      document.getElementById("greeting").innerText = greeting + ", " + userName + "!";
    }

    function openModal(id) {
      document.getElementById(id).classList.add('active');
      if (id === 'testSelectionModal') buildTopicList();
      if (id === 'profileModal') updateProfile();
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    document.querySelectorAll('.modal').forEach(m => {
      m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); });
    });

    function buildTopicList() {
      const topics = new Set();
      Object.keys(allTests).forEach(subject => {
        Object.keys(allTests[subject]).forEach(t => topics.add(subject + ": " + t));
      });
      const container = document.getElementById('topics');
      if (topics.size === 0) {
        container.innerHTML = '<p style="text-align:center;padding:2rem;color:#666;">Вопросы не найдены</p>';
        return;
      }
      container.innerHTML = Array.from(topics).sort().map(t => `
        <label style="display:flex;align-items:center;background:#f9f9f9;padding:1rem;border-radius:12px;border:1px solid #ddd;margin-bottom:0.5rem;cursor:pointer;">
          <input type="checkbox" value="${t}" style="margin-right:1rem;width:1.4rem;height:1.4rem;">
          <span style="font-size:1.1rem;">${t}</span>
        </label>
      `).join('');
    }

    function startTest() {
      const selected = [...document.querySelectorAll('#topics input:checked')].map(el => el.value);
      if (selected.length === 0) return alert('Выберите хотя бы один раздел!');

      const customCount = parseInt(document.getElementById('question-count-custom').value) || 0;
      testSettings = {
        count: customCount > 0 ? customCount : 0,
        timer: document.getElementById('use-timer').checked,
        timerMinutes: parseInt(document.getElementById('timer-minutes').value) || 30,
        blind: document.getElementById('blind-mode').checked
      };

      currentTest = [];
      selected.forEach(fullTopic => {
        const [subject, topic] = fullTopic.split(": ");
        if (allTests[subject] && allTests[subject][topic]) {
          currentTest.push(...allTests[subject][topic].map(q => ({...q, topic})));
        }
      });

      if (currentTest.length === 0) return alert('Нет вопросов');
      currentTest.sort(() => Math.random() - 0.5);
      if (testSettings.count > 0 && testSettings.count < currentTest.length) {
        currentTest = currentTest.slice(0, testSettings.count);
      }

      currentTest.forEach(q => {
        const paired = q.options.map((opt, i) => ({
          opt,
          correct: Array.isArray(q.correct) ? q.correct.includes(i) : q.correct === i
        }));
        paired.sort(() => Math.random() - 0.5);
        q.options = paired.map(p => p.opt);
        if (Array.isArray(q.correct)) {
          q.correct = paired.map((p, idx) => p.correct ? idx : -1).filter(x => x !== -1);
        } else {
          q.correct = paired.findIndex(p => p.correct);
        }
      });

      currentIndex = 0; correctInSession = 0; startTime = Date.now();
      testInProgress = true;

      if (testSettings.timer) {
        let seconds = testSettings.timerMinutes * 60;
        timerInterval = setInterval(() => {
          seconds--;
          const m = String(Math.floor(seconds / 60)).padStart(2, '0');
          const s = String(seconds % 60).padStart(2, '0');
          const el = document.getElementById('timer');
          el.textContent = `${m}:${s}`;
          el.style.display = 'block';
          el.className = seconds < 60 ? 'danger' : seconds < 300 ? 'warning' : '';
          if (seconds <= 0) { clearInterval(timerInterval); endTest(); }
        }, 1000);
      }

      closeModal('testSelectionModal');
      showQuestion();
      openModal('testModal');
    }

    function updateArrows() {
      const prev = document.getElementById('prev-arrow-top');
      const next = document.getElementById('next-arrow-top');
      prev.className = currentIndex === 0 ? 'disabled' : '';
      next.className = currentIndex >= currentTest.length - 1 ? 'disabled' : '';
    }

    document.getElementById('prev-arrow-top').onclick = () => { if (currentIndex > 0) { currentIndex--; showQuestion(); } };
    document.getElementById('next-arrow-top').onclick = () => { if (currentIndex < currentTest.length - 1) { currentIndex++; showQuestion(); } };

    document.addEventListener('keydown', e => {
      if (!testInProgress || document.getElementById('exitConfirmModal').classList.contains('active')) return;
      if (e.key === 'ArrowLeft' && currentIndex > 0) { currentIndex--; showQuestion(); }
      if (e.key === 'ArrowRight' && currentIndex < currentTest.length - 1) { currentIndex++; showQuestion(); }
    });

    function showExitConfirm() {
      if (!testInProgress) { closeModal('testModal'); return; }
      openModal('exitConfirmModal');
    }

    function forceExit() {
      testInProgress = false;
      clearInterval(timerInterval);
      closeModal('exitConfirmModal');
      closeModal('testModal');
    }

    function showQuestion() {
      if (currentIndex >= currentTest.length) { endTest(); return; }
      const q = currentTest[currentIndex];

      document.getElementById('question').innerHTML = q.question;
      document.getElementById('current-num').textContent = currentIndex + 1;
      document.getElementById('total-num').textContent = currentTest.length;
      document.getElementById('progress').style.width = ((currentIndex + 1) / currentTest.length * 100) + '%';

      const isMultiple = Array.isArray(q.correct);
      document.getElementById('options').innerHTML = q.options.map((opt, i) => `
        <label class="option">
          <input type="${isMultiple ? 'checkbox' : 'radio'}" name="answer" value="${i}" onchange="toggleAnswerBtn()">
          <span>${opt}</span>
        </label>
      `).join('');

      document.querySelectorAll('#options input').forEach(i => { i.checked = false; i.disabled = false; });
      document.querySelectorAll('.option').forEach(l => { l.style.background = ''; l.style.borderColor = '#e5e7eb'; });

      const btn = document.getElementById('answer-btn');
      btn.disabled = true;
      btn.textContent = 'Ответить';
      btn.style.opacity = '0.6';
      btn.onclick = checkAnswer;

      updateArrows();
    }

    function toggleAnswerBtn() {
      const checked = document.querySelector('#options input:checked');
      const btn = document.getElementById('answer-btn');
      if (checked) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.background = 'linear-gradient(135deg, #3b82f6, #6d28d9)';
      } else {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.style.background = '';
      }
    }

    function checkAnswer() {
      const selected = [...document.querySelectorAll('#options input:checked')].map(el => +el.value);
      const q = currentTest[currentIndex];
      const correct = Array.isArray(q.correct) ? q.correct : [q.correct];

      if (correct.length === selected.length && correct.every(v => selected.includes(v))) correctInSession++;

      if (!testSettings.blind) {
        document.querySelectorAll('.option').forEach((label, i) => {
          const input = label.querySelector('input');
          input.disabled = true;
          if (correct.includes(i)) {
            label.style.background = '#d1fae5';
            label.style.borderColor = '#22c55e';
          }
          if (selected.includes(i) && !correct.includes(i)) {
            label.style.background = '#fee2e2';
            label.style.borderColor = '#ef4444';
          }
        });
      }

      const btn = document.getElementById('answer-btn');
      btn.textContent = currentIndex + 1 === currentTest.length ? 'Завершить' : 'Далее →';
      btn.onclick = () => { currentIndex++; showQuestion(); };
    }

    function endTest() {
      testInProgress = false;
      clearInterval(timerInterval);

      const percent = Math.round((correctInSession / currentTest.length) * 100);
      const timeSpent = Math.round((Date.now() - startTime) / 1000);
      const mins = Math.floor(timeSpent / 60), secs = timeSpent % 60;

      document.getElementById('results-name').textContent = userName;
      document.getElementById('final-score').textContent = correctInSession;
      document.getElementById('final-total').textContent = currentTest.length;
      document.getElementById('final-percent').textContent = percent;
      document.getElementById('time-spent').textContent = `Время: ${mins} мин ${secs} сек`;

      stats.tests += 1;
      stats.correct += correctInSession;
      localStorage.setItem('medtests_stats', JSON.stringify(stats));

      closeModal('testModal');
      openModal('resultsModal');
      updateProfile();
    }

    function updateProfile() {
      document.getElementById("profileInfo").innerHTML = `Имя: ${userName}<br>Курс: ${userCourse}<br>Факультет: ${userFaculty}`;
      document.getElementById('tests-completed').textContent = stats.tests;
      document.getElementById('correct-total').textContent = stats.correct;
      const avg = stats.tests > 0 ? Math.round((stats.correct / (stats.tests * 50)) * 100) : 0;
      document.getElementById('avg-percent').textContent = avg;
    }

    document.getElementById("settingsForm").addEventListener("submit", function(e) {
      e.preventDefault();
      userName = document.getElementById("setName").value.trim();
      userCourse = document.getElementById("setCourse").value;
      userFaculty = document.getElementById("setFaculty").value;
      if (!userName || !userCourse || !userFaculty) return;
      user = { name: userName, course: userCourse, faculty: userFaculty };
      localStorage.setItem('medtests_user', JSON.stringify(user));
      updateGreeting(); updateProfile(); closeModal('settingsModal');
    });

    window.addEventListener('beforeunload', e => {
      if (testInProgress) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Пасхалка Вовы
    let vovaBuffer = '';
    document.addEventListener('keydown', (e) => {
      if (e.key.length === 1 && /[а-яё]/i.test(e.key)) {
        vovaBuffer += e.key.toLowerCase();
      } else if (e.key === 'Backspace') {
        vovaBuffer = vovaBuffer.slice(0, -1);
      } else {
        vovaBuffer = '';
        return;
      }
      if (vovaBuffer.length > 10) vovaBuffer = vovaBuffer.slice(-10);
      if (vovaBuffer.includes('вова')) {
        document.getElementById('vova-cat').classList.add('show');
        setTimeout(() => document.getElementById('vova-cat').classList.remove('show'), 3000);
        vovaBuffer = '';
      }
    });
  </script>
</body>
</html>
